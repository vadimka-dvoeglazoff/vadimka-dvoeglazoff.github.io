---
layout: post
title: Добавление комментариев (Staticman) на статичные сайты (GitHub Pages). Альтернатива Heroku.
tags: [Staticman, Heroku, Render, GitHub Pages]
comments: true
author: Вадим Двоеглазов
---

1. Для начала необходимо зарегистрировать новую учетную запись на GitHub. Назовем её к примеру, **staticman-bot**. Для этой новой учетной записи создаем персональный токен доступа. 
Создание нового аккаунта на GitHub и использование его токена доступа обуславливается тем, что этот токен будет использован для приложения **Render**, а следовательно, может быть скомпрометирован
и кто-то может получить доступ к вашему основному аккаунту. Кроме этого, использование второго аккаунта позволяет удобно разделить коммиты комментариев от ваших правок в репозитории сайта. 
Для создание токена необходимо:
- Перейти в [настройки разработчика](https://github.com/settings/tokens)
- Нажать **Generate new token - Generate new token (classic)**
- Подтвердить учетные данные введя пароль (может и не запросить)
- Придумать и ввести название токена, к примеру, **staticman-bot**
- Выдать разрешение к двум разделам (**repo** и **user**) отметив их галочками
- Сгенерировать токен (кнопка внизу страницы **Generate token**) и сохранить где-нибудь отображенный токен, так как далее Github не даст его подсмотреть в целях безопасности.
2. Из основной учетной записи на GitHub необходимо отправить приглашение к сотрудничеству новой, только что созданной, учетной записи на GitHub (**staticman-bot**). 
Для этого:
- На основной учетной записи переходим в настройки репозитория
- Кликаем по пункту меню **Collaborators**, в поле таблицы **Manage access** ищем новый аккаунт по имени (в нашем примере это **staticman-bot**) и отправляем приглашение
- Из новой учетной записи необходимо принять приглашение
3. Генерируем RSA ключ. Для этого необходимо выполнить команду:

`ssh-keygen -m PEM -t rsa -b 4096 -C "staticmankey" -f ~/.ssh/staticman_key`

Проверить, что сгенирирован правильный ключ можно выполнив команду:

`head -2 ~/.ssh/staticman_key`

Строка **BEGIN RSA PRIVATE KEY** означает, что все сделано правильно, любой другой вариант (например, **OPENSSH PRIVATE KEY**) означает, что что-то пошло не так и этот вариант не будет работать. 
По умолчанию ключи SSH хранятся в **/home/$USER/.ssh**

4. Осталось развернуть приложение для API-прослойки. Перед этим зарегистрируйтесь на ресурсе [Render](https://render.com/). После регистрации:
- Создайте приложение выбрав **New - New Web Service**
- На первом шаге оставьте по умолчанию **Build and deploy from a Git repository** и нажмите **Next**
- Далее нам нужен вариант с публичным репозиторием внизу страницы, вводим туда путь к репозиторию Staticman - `https://github.com/eduardoboucas/staticman` и жмем **Continue**
- Вводим имя приложения, к примеру, **staticman-bot**
- Выбираем регион Franfurkt
- В пункте **Auto-deploy** выбираем **No**, чтобы Render не обновлял приложение после каждого изменения в репозитории Staticman
- В пункте **Advanced** вводим переменную **RSA_PRIVATE_KEY** (вставляем значение из созданного в п.3 файла закрытого ключа) и переменную **GITHUB_TOKEN** (вставляем значение из сгенерированного и сохраненного 
токена доступа в п.1)
- Нажимаем кнопку **Create Web Service** и ждем пока в логах запуска не отобразится `Staticman API running on port 10000`, это будет значить, что приложение успешно запущено.

Для проверки работы приложения необходимо открыть наше приложение по ссылке, которая будет вверху сайта и будет выглядеть примерно так: **https://имя-приложения.onrender.com**. 
Перейдя по ссылке мы должны увидеть приветствие Staticman:

`Hello from Staticman version 3.0.0!`

В репозитории самого статического сайта **Jekyll** тоже необходимо внести изменения.

В файле **_config.yml**:
- Для **staticman** указать параметры:
  - **repository**: "имя-аккаунта-GitHub/название-репозитория-сайта-Jekyll"
  - **branch**: **master** по умолчанию, измените, если у Вас другой
  - **endpoint**: "ссылка-на-развернутое-в-п.4-приложение/v2/entry/"

В файле **staticman.yml**:
- Указать параметр **allowedOrigins**: ["ссылка-на-главную-страницу-сайта-Jekyll"]
